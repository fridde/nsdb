## SET VARIABLES
echo nsdb /mnt/d/staging 'https://github.com/fridde/nsdb.git' | read PROJECT_NAME STAGING GITHUB
echo 'https://nsdb.sigtunanaturskola.se' /mnt/d/Dropbox/scripts | read WEBPAGE DROPBOX_SCRIPTS

cd $DROPBOX_SCRIPTS/$PROJECT_NAME
sf-dmm

build_outlook_interactor

composer install --no-scripts

npm run dev

git status
git commit -a -m "More work"
git push

# winphp ./vendor/bin/phpunit

cd $STAGING

archive_project $PROJECT_NAME

git clone $GITHUB --depth=1 && cd $PROJECT_NAME

cp $SCRIPTS$PROJECT_NAME/{.env.prod.local,deployment.php} .

echo 'APP_ENV=prod' > .env.local

composer install --no-scripts --no-dev --optimize-autoloader --classmap-authoritative
## Run until all removed
while true; composer google-cleanup && break; end


cd $SCRIPTS$PROJECT_NAME
npm run build
cons assets:install

cp -r public/{build,bundles} $STAGING/$PROJECT_NAME/public

cd $STAGING/$PROJECT_NAME

./vendor/bin/deployment deployment.php

## REPEAT IF EXCEPTION OCCURS
for i in (seq 3); set KEY (cons -e prod app:key-for-id t); end
cmd.exe "/C start "$WEBPAGE"/cron/run-tasks?key="$KEY
